<html>
<header>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="default.min.css">
    <link rel="stylesheet" href="tailwind.min.css">
</header>

<body class="container w-full mx-auto dark:bg-gray-900">
    <script src=" toc.js"></script>
    <article class="format dark:format-invert w-[90vw] max-w-screen-md lg:w-full relative bg-white dark:bg-gray-900">
        <section id="controllers_routing">
            <h1>Controllers & Routing</h1>
            <p>Controllers handle incoming HTTP requests and determine the appropriate response, while routing maps
                incoming URLs to specific controller methods. For example, the URL <code>/user/view</code> doesn't
                directly
                correspond to a physical file; instead, the routing mechanism directs the request to the correct
                controller.</p>
            <div id="routing">
                <h2> Routing</h2>

                <p>Routing associates a URI with a controller method. Fuwafuwa Framework uses the following steps to
                    determine the appropriate handler for a given request:</p>

                <ol>
                    <li><strong>Path Decomposition</strong>: The incoming URL is split into two parts: the class name
                        and
                        the action method. The last segment of the URL becomes the action, and the remaining part forms
                        the
                        class name. For instance, <code>/user/admin/add</code> would result in the
                        <code>User\Admin</code> class and
                        the <code>add</code>
                        action.
                    </li>
                    <li><strong>Controller Search</strong>: The framework looks for a matching controller class in the
                        <code>app/controllers</code> directory. If found, the corresponding method is executed.
                    </li>
                    <li><strong>View Search</strong>: If no matching controller is found, the framework searches for a
                        view
                        file with the same name as the URL (e.g., <code>user/admin/add.html</code>) in the app/views
                        directory. If
                        found,
                        the <code>\Fuwafuwa\Controller\View</code> controller is implicitly created to render the view.
                    </li>
                    <li><strong>404 Error</strong>: If neither a controller nor a view is found, a 404 error is
                        returned.
                    </li>
                </ol>

                <h4> Controllers Folder</h4>

                <p>Controllers are PHP classes typically located in the <code>app/controllers</code> directory. Fuwafuwa
                    Framework
                    employs a dual-root structure with system and user subfolders. The system folder contains core
                    framework
                    controllers and utilities, while the user folder is reserved for custom application controllers.</p>

                <p>The framework prioritizes controllers in the user folder over those in the system folder. When a
                    request
                    arrives, the search for a matching controller begins in <code>app/controllers/user</code>, followed
                    by
                    <code>app/controllers/system</code>. If no controller is found, the search continues in the views
                    folder.
                </p>

                <h4> Views Folder</h4>

                <p>Similar to the controllers folder, the views folder uses a triple-root structure: system, themes, and
                    user. This organization allows for system updates without overwriting custom views. To customize
                    system
                    or theme views, it's recommended to copy the desired files to the user folder and make modifications
                    there.</p>
            </div>
        </section>
        <section id="controllers">
            <div>
                <h2>Controllers</h2>
                <p>A controller is a PHP class responsible for handling incoming HTTP requests and generating
                    responses. It
                    typically implements the <code>\Fuwafuwa\Controller</code> interface or defines
                    <code>execute</code>
                    method.
                </p>

                <pre class="not-format">
<code>
class Example implements \Fuwafuwa\Controller {
    function execute(\Base $f3, string $action = ""){
        print "Hello";
    }
};
</code>
</pre>
            </div>
        </section>
        <section id="authentication">
            <div>
                <h2>Authentication</h2>
                <img class="md:w-1/2" src="images/authentication.webp">
                <p>Fuwafuwa Framework provides a built-in authentication mechanism implemented in
                    <code>app/controllers/user/model/user.php</code>. By default, user credentials are validated
                    against the
                    <code>user</code> table.
                <h3>Custom Authentication</h3>
                <p>To implement custom authentication logic, create a class that extends the default authentication
                    class
                    and overrides the login method. The login method should return an array with the following
                    structure:
                </p>
                <pre class="not-format"> <code class="language-php">[
    'authed' => true, // or false if invalid login
    'user' => [ // will be put in SESSION
        'username' => $user['login'],
        'fullname' => $user['fullname'],
        'group' => $user['role']
    ]
];</code></pre>
                To register your custom authentication class, set the <code>auth_class</code> key in the APP section
                of the
                <code>app/configs/config.ini</code> file.
                </p>
            </div>
        </section>
        <section id="authorization">
            <div>
                <h2>Authorization</h2>
                <p>
                    Fuwafuwa Framework utilizes Role-Based Access Control (RBAC) for authorization. Permissions are
                    defined in two configuration files: <code>app/configs/permissions.ini</code> and
                    <code>app/configs/rbac.ini</code>. Access control decisions are based on the user[group] value
                    stored in the session after successful authentication.
                </p>
                <h3>permissions.ini</h3>
                <p>
                <pre class="not-format"><code class="language-ini">[user Users]
user.list = List user
user.edit = Edit user
user.view_roles = "{{ t('role.view_rights') }}"
user.edit_roles = "{{ t('role.edit_rights') }}"

[post Post & Page]
page.list = List Page
page.edit = Edit Page
post.list = List Post
post.edit = Edit Post
media.manage = Manage Media</code></pre>
                </p>
                <p>
                    This file defines roles and permissions for users in your system. Here's a breakdown:

                <ul>
                    <li>
                        <b>Sections:</b> Each section represents a user role group (e.g., [user Users]). The section
                        name has two parts:
                        <ul>
                            <li><b>Code Name:</b> Used internally by the framework (e.g., user).</li>
                            <li><b>Display Name:</b> Shown in the role editor interface (e.g., "Users").</li>
                        </ul>
                    </li>
                    <li>
                        <b>Permission Definition:</b> Each line defines a permission within a role group. It follows
                        the format: <code>[permission group].[permission] = display name</code>.
                        <ul>
                            <li><b>Permission Group:</b> Category for the permission (e.g., user.list).</li>
                            <li><b>Permission:</b> Specific action (e.g., list).</li>
                            <li><b>Display Name:</b> Human-readable description of the permission, optionally using
                                the t() function for translations.</li>
                        </ul>
                    </li>
                </ul>
                </p>
                <img src="images/role-editor.webp">
                <h3>rbac.ini</h3>
                <p>
                <pre class="not-format"><code class="language-ini">[RBAC.global]
; superuser has all permissions except denied
superuser = admin
supergroup = admin
superuser_deny = member.all
guest_allow = guest.misc,user.login,page.view,post.view
guest_deny = page.edit,post.edit
authed_allow = member.all
authed_deny = member.register

[RBAC.guest]
misc = /test*,/fuwafuwa/generator/*
chinook = /chinook/*,/ajax/chinook/*

[RBAC.user]
list = /admin/user,/ajax/user/list
edit = /ajax/user/edit
view_roles = /admin/roles,/ajax/user/roles
edit_roles = /ajax/user/edit-roles,/ajax/user/get-permission,/ajax/user/set-permission
login = /login,/logout

[RBAC.post]
view = /post/*
edit = /post/edit,/post/table,/ajax/content/post*,/ajax/content/upload,/ajax/content/image-list,/content/category,/ajax/content/cat*
</code></pre>
                </p>
                <p>This file defines which user roles have access to specific application paths (URLs).

                <ul>
                    <li><b>Sections:</b> Similar to permissions.ini, sections can represent global rules or specific
                        user roles (e.g., <code>[RBAC.global]</code>, <code>[RBAC.user]</code>).</li>
                    <li><b>Permissions:</b> Each line defines allowed paths for a certain permission. Wildcards (*)
                        can be used to match multiple paths.</li>
                </ul>
                </p>
                <p>
                    Notes:

                <ul>
                    <li>In the <code>[RBAC.global]</code> section, we define superuser and guest roles with allowed
                        and denied permissions.</li>
                    <li>The <code>[RBAC.guest]</code> and <code>[RBAC.user]</code> sections specify allowed paths
                        for specific roles. For example, <code>/admin/user</code> is accessible only to users with
                        the user</li>
                </ul>
                </p>
            </div>
        </section>
        <section id="sql">
            <h2>Model &amp; SQL</h2>
            <p>Fuwafuwa Framework provides a <code>BaseModel</code> class to simplify database interactions. This class
                handles common CRUD operations and offers additional features for data retrieval and manipulation.
            </p>
            <pre class="not-format"><code>&lt;?php

namespace Model;
    
class User extends \Fuwafuwa\BaseModel {

    function __construct(\Fuwafuwa\Db $db) {
    parent::__construct($db, 'user', ['ai_field' => 'login', 'created_field' => 'created', 'modified_field' => 'updated', 'deleted_field' => 'deleted', ]);
</code></pre>
            <h3>Data Retrieval</h3>
            <p>To retrieve data from the database, you can use either the <code>retrieve</code> method or the original
                <code>load</code> method inherited from the F3 framework.
            </p>
            <pre class="not-format"><code>$user = m('\Model\User');
$user->load(['login = ?', 'admin']);
if($user->loaded()) {
    print $user->fullname;
    // or
    print $user['fullname'];
} else {
    print "user not found";
}</code></pre>
            <h3>Data Manipulation</h3>
            <h4>Updating Records:</h4>
            <p>
                After a record successfully loaded, we can modify the data.
            </p>
            <pre class="not-format"><code>$user = m('\Model\User');
$user->load(['login = ?', 'admin']);
if($user->loaded()) {
    $user->fullname = 'Super Admin';
    $user->save();
} else {
    print "user not found";
}</code></pre>
            <h4>Inserting New Records:</h4>
            <pre class="not-format"><code>$user = m('\Model\User');
$user->login = 'user';
$user->fullname = 'User';
$user->save();
</code></pre>
            <h3>Raw SQL Queries</h3>
            <p>
                For complex queries that require joins or custom SQL logic, you can use the <code>SQL</code> trait:</p>
            <pre class="not-format"><code>use \Fuwafuwa\Traits\SQL;
function user_count() {
    $count = $this->SQL('SELECT COUNT(1) FROM user')[0][0];
    // or
    $count = $this->FSQL1('SELECT COUNT(1) FROM user');
}</code></pre>
        </section>
        <section id="ajax">
            <h2>Ajax Interactions</h2>
            <p>Fuwafuwa Framework simplifies asynchronous communication with your server using Ajax for dynamic content
                updates. This section explores utilizing the <code>\Fuwafuwa\Controller\Ajax</code> class and its
                functionalities.</p>

            <ol>
                Server-Side with <code>\Fuwafuwa\Controller\Ajax</code>
                <li>
                    <b>Extending the Ajax Class:</b> Create a class that extends \Fuwafuwa\Controller\Ajax. This
                    establishes the foundation for your Ajax controller.
                </li>

                <li><b>Handling Requests:</b> Define methods within your Ajax controller class to handle specific Ajax
                    requests. These methods typically receive the F3 framework instance as an argument ($f3).</li>

                <li><b>Accessing Data:</b> Fuwafuwa Framework automatically parses the request body (if it's a POST
                    request) and provides the data as an array in the $data property of your controller. You can also
                    access query parameters using standard F3 techniques.</li>

                <li><b>Processing and Returning Data:</b> Inside your Ajax controller method, process the received data,
                    perform any necessary operations (e.g., database interactions), and prepare a response. The sendJson
                    method provided by the Ajax class simplifies sending JSON responses to the client.</li>
            </ol>
            <pre class="not-format"><code>&lt;?php

namespace Ajax;

class Test extends \Fuwafuwa\Controller\Ajax {
    use \Fuwafuwa\Traits\Content;

    function country($f3) {
        // Access query parameter 'q'
        $q = $this->data['q'];

        // Process and filter countries data
        $countries = array_column(json_decode($this->json, true), 'name');
        $result = $this->filterCountries($countries, $q);

        // Send JSON response
        $this->sendJson($result);
    }

    private function filterCountries($countries, $q) {
        if ($q) {
            // Filter countries based on query string
            return array_values(array_filter($countries, fn($e) => stripos($e, $q) !== false));
        } else {
            // Return a subset of countries if no query is provided
            return array_values(array_slice($countries, 0, 10));
        }
    }
}</code></pre>
            <h3>Client-Side JavaScript</h3>
            <p>
                Fuwafuwa Framework might not offer built-in JavaScript methods for Ajax requests, but here's a general
                approach:

            <ol>
                <li><b>Fetch Data:</b> Use the fetch API or a suitable library to make Ajax requests to your server-side
                    Ajax controller endpoints.</li>

                <li><b>Process Response:</b> Parse the JSON response received from the server.</li>

                <li><b>Handle Success/Error:</b> Implement logic to display success notifications (e.g., popups) or
                    error messages based on the response data.</li>
            </ol>
            </p>
            <pre class="not-format"><code>save() {
    this.data['content'] = tinymce.get('content').getContent();
    fetchData('{{@BASE}}/ajax/content/post-edit', { data: this.data, oper: this.data.id ? 'edit' : 'add' }).then(data => 
        popupInfo('Post sudah disimpan')                
    ).catch(e => popupError(e));
}</code></pre>
        </section>
        <section id="api">
            <h2>API</h2>
            Fuwafuwa Framework simplifies the creation of APIs through its <code>\Fuwafuwa\Controller\Api</code> base
            class. This class provides a foundation for building API endpoints with essential functionalities.
            <h3>Core Features</h3>
            <ul>
                <li>
                    <pb>Simplified Response Handling:</pb> The sendJson method conveniently formats and sends JSON
                    responses.
                </li>
                <li>
                    <p>Automatic Data Parsing:</p> Incoming request data is automatically parsed and made accessible
                    through the <code>$data</code> property.
                </li>
                <li><b>Bearer Token Authentication:</b> Built-in support for Bearer Token authentication, ensuring
                    secure API access.</li>
            </ul>
            <h3>Creating an API Endpoint</h3>
            <ol>
                To create an API endpoint, follow these steps:

                <li><b>Create an API Controller:</b> Extend the \Fuwafuwa\Controller\Api class and define methods for
                    your API endpoints.</li>
                <li><b>Define API Logic:</b> Implement the desired logic within your controller methods.</li>
                <li><b>Return JSON Response:</b> Utilize the sendJson method to send JSON-formatted data as the API
                    response.</li>
            </ol>
            <pre class="not-format"><code>&lt;?php

namespace Api;

class Common extends \Fuwafuwa\Controller\Api {

    use \Fuwafuwa\Traits\Content;

    function register(\Base $f3): void {
        $this->sendJson(c('\Fuwafuwa\Service\Member')->register($this->data));
    }

    function activation(\Base $f3): void {
        $this->sendJson(c('\Fuwafuwa\Service\Member')->activate($this->data));
    }
}</code></pre>
        </section>
        <section id="cli">
            <h2>CLI (Command-Line Interface)</h2>
            <p>Fuwafuwa Framework provides a CLI (Command-Line Interface) component for executing tasks directly from
                the command line. This is particularly useful for automating processes, running scripts, or performing
                administrative tasks.</p>

            <h3>Creating CLI Commands</h3>
            <p>To create a CLI command, extend the \Fuwafuwa\Controller\Cli class and define public methods within your
                class. These methods will become available as CLI commands.</p>


            <pre class="not-format">class Generator extends \Fuwafuwa\Controller\Cli implements \Fuwafuwa\Controller\Controller {

/**
    * List available generators.
    *
    * @param \Base $f3
    * @return void
    */
function list(\Base $f3): void {
    $methods = get_class_methods(self::class);
    $methods = array_filter($methods, function ($m) {
        $ref = new \ReflectionMethod(self::class, $m);
        return $ref->isPublic();
    });
    array_splice($methods, 0, 5);
    print join("\n", $methods);
}</pre>
            <h3>Executing CLI Commands</h3>
            <p>To execute a CLI command, run the following command from your project's root directory:</p>
            <pre class="not-format"><code>php index.php &lt;controller_name>/&lt;method_name> [arguments]</code></pre>

            <pre class="not-format"><code>php index.php fuwafuwa/generator/model --table=user</code></pre>
            <p>This will execute the <code>list</code> method within the <code>Generator</code> class.</p>
            <h3>Command-Line Arguments</h3>
            <p>CLI commands can accept arguments using the <code>$f3['GET']</code> variable. The getopt function can be
                used to parse command-line arguments and populate the <code>$f3['GET']</code> array. Example:</p>

            <pre
                class="not-format"><code>php index.php fuwafuwa/generator/model --table=users --fields=id,name,email</code></pre>

            <p>In this example, <code>--table=users</code> and <code>--fields=id,name,email</code> are passed as
                arguments and can be accessed in the Generator class using <code>$f3['GET']['table']</code> and
                <code>$f3['GET']['fields']</code>.
            </p>
        </section>
    </article>
    <nav class="flex py-4">
        <a href="models.html">
            <button type="button"
                class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">Prev</button>
        </a>
        <a href="views.html">
            <button type="button"
                class="text-gray-900 bg-white border border-gray-300 focus:outline-none hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 font-medium rounded-lg text-sm px-5 py-2.5 mr-2 mb-2 dark:bg-gray-800 dark:text-white dark:border-gray-600 dark:hover:bg-gray-700 dark:hover:border-gray-600 dark:focus:ring-gray-700">Next</button>
        </a>

    </nav>
    <script src="highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</body>

</html>
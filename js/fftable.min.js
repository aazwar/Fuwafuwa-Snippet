"use strict";function fetchData(t,e,s=!0){return new Promise(((i,a)=>{let o={method:"POST",body:e instanceof FormData?e:JSON.stringify(e)};s&&(o.headers={"Content-Type":"application/json"}),fetch(t,o).then((async t=>{const e=await t.text();try{return JSON.parse(e)}catch(e){switch(t.status){case 401:a("Unauthorized access. Your session may be expired, please relogin");break;case 403:a("Access denied!");break;default:a(`${t.status} - ${t.statusText}`)}}})).then((t=>{t.code?a(t.status+"<br/><br/>"+t.text):t.success?i(t.data):a(t.message||t.data)})).catch((t=>a(t)))}))}function deepEqual(t,e){const s=Object.keys,i=typeof t;return t&&e&&"object"===i&&i===typeof e?s(t).length===s(e).length&&s(t).every((s=>deepEqual(t[s],e[s]))):t===e}const isFunction=t=>Boolean(t&&"function"==typeof t);function functioning(t,e){return"function"==typeof t?(...s)=>t(...s,e):null==t?()=>null:()=>t}function valuing(t,e,...s){return"function"==typeof t?t(e,...s):e}function alpining(...t){const e={};return t.forEach((t=>{"object"==typeof t&&null!==t?Object.keys(t).forEach((s=>{t[s]&&(e[s]=t[s])})):t&&(e[t]=!0)})),e}function deepAssign(t,...e){for(let s of e)for(let e in s)Object.prototype.hasOwnProperty.call(s,e)&&("object"==typeof s[e]&&null!==s[e]?(t[e]=Array.isArray(s[e])?[]:{},deepAssign(t[e],s[e])):t[e]=s[e]);return t}function ffOptions(t){if(Array.isArray(t))return t;let e=t.split("|");return e[0].match(/#/)?e.map((t=>{let[e,s]=t.split("#",2);return{label:e,value:s}})):e.map((t=>({value:t,label:t})))}function FFTable(t){const e=["","¹","²","³","⁴","⁵","⁶","⁷","⁸","⁹"],s=new Intl.NumberFormat(LOCALE,{style:"decimal",minimumFractionDigits:0,maximumFractionDigits:0});function i(t,e){let s,i=e,a=t-1,o=t+1+1,r=[],l=[];for(s=1;s<=i;s++)(1==s||s==i||s>=a&&s<o)&&r.push(s);let h=0;return r.forEach((t=>{h&&(t-h==2?l.push(h+1):t-h!=1&&l.push("...")),l.push(t),h=t})),l}return{fields:[],form:{id:"form_"+(Math.random()+1).toString(36).substring(7),modalId:"modal"+(Math.random()+1).toString(36).substring(7),class:{},size:"small",columns:1,formInit:null,onShow:null,onSubmitted:null,watch:[]},table:{id:"table"+(Math.random()+1).toString(36).substring(7),masterId:"",masterChanged:null,afterFetch:null,containerId:"tabCont_"+(Math.random()+1).toString(36).substring(7),addable:!0,editable:!0,deletable:!0,searchable:!0,printable:!1,exportable:!1,selection:"single",selectionCheckbox:!1,sorting:"multiple",toolbar:[],limit:[],showToolbar:!0,showFilter:!1,sort:[],pageSize:30,class:{},formatter:{},sortable:{},display:"normal",displayClass:"h-[60vh]",rowClass:"",size:"large",queryTrans:{},noDataMessage:"No data available",functions:{},deferLoading:!1},meta:{loading:!1,status:null},params:{size:30,pos:0,search:null,fields:[],searchable:[],limit:[],filter:[]},state:{pos:0,q:null,count:0,total:0},dispatch(t,e={}){window.dispatchEvent(new CustomEvent(t,{detail:e,bubbles:!0,composed:!0,cancelable:!0}))},cols:[],titles:[],paging:[],rows:[],sort:[],selection:[],data:{},errors:{},formModal:null,init(){let e=["fields","table","form"];e.forEach((e=>Object.assign(this[e],t[e]))),Object.keys(t).filter((t=>!e.includes(t))).forEach((e=>this[e]=t[e])),this.form.pk?"string"==typeof this.form.pk&&(this.form.pk=this.form.pk.split(/[\s,\|]+/)):this.table.deletable=!1,this.fields.forEach((t=>{t.fclass&&(this.form.class[t.name]=t.fclass),t.watch&&(this.form.watch=[...this.form.watch,...t.watch]),t.class&&(this.table.class[t.name]=t.class),t.type?.match(/select|radio/)&&!isFunction(t.formatter)&&t.options&&(t.formatter=e=>ffOptions(t.options).find((t=>t.value==e))?.label),t.type?.match(/uploader/)&&(t.raw=!0,t.formatter=t=>t?.downloadkey?`<a href="/download?downloadkey=${t.downloadkey}" target="_blank">${t.name}</a>`:"",t.encoder=t=>JSON.stringify(t),t.decoder=t=>JSON.parse(t),t.default={}),t.formatter&&(this.table.formatter[t.name]=t.formatter),this.table.sortable[t.name]=!0,"boolean"==typeof t.sortable&&(this.table.sortable[t.name]=t.sortable),"boolean"==typeof t.visible||(t.visible=!0);let e=t.queryPrefix?t.queryPrefix+".":"";this.table.queryTrans[t.name]=e+t.name,t.searchable&&this.params.searchable.push({col:e+t.name,op:t.searchable}),t.filter&&this.params.filter.push({title:t.title,col:e+t.name,op:t.filter?.op||"LIKE",value:""})}));let s=this.fields.filter((t=>t.order));if(s.length){let t=this.fields.filter((t=>!t.order));if(t){let e=Math.max(...s.map((t=>t.order)));t.forEach(((t,s)=>t.order=e+s+1))}}this.form.watch=[...new Set(this.form.watch)],this.cols=this.fields.filter((t=>t.visible&&!t.hidden)).toSorted(((t,e)=>t.order-e.order)).map((t=>t.name)),this.titles=this.fields.filter((t=>t.visible&&!t.hidden)).toSorted(((t,e)=>t.order-e.order)).map((t=>t.title)),this.form.fields=this.fields.filter((t=>!(t.virtual||t.hidden))),this.params.fields=this.fields.filter((t=>!t.virtual)).map((t=>t.queryPrefix?t.queryPrefix+"."+t.name:t.name)),this.params.size=this.table.pageSize,this.params.limit=this.table.limit,this.params.sort=this.table.sort,isFunction(this.form.formInit)&&setTimeout((()=>this.data=this.form.formInit(this.data)),500),isFunction(this.table.tableInit)&&(this.table.tableInit.bind(this),this.table.tableInit(this)),this.table.deferLoading||this.fetch()},fetch(){if(this.selection.length&&(this.selection=[],this.data={},this.dispatch("table-event",{event:"deselect",table:this.table.id})),this.table.data){let t=[...this.table.data];this.sort.length&&t.sort(((t,e)=>{for(let s of this.sort){let i=s.col,a=s.sort;if(t[i]<e[i])return"asc"===a?-1:1;if(t[i]>e[i])return"asc"===a?1:-1}return 0})),this.rows=t.slice(this.params.pos*this.params.size,(this.params.pos+1)*this.params.size),this.state.total=t.length,this.state.count=Math.floor(t.length/this.params.size)+(t.length%this.params.size?1:0),this.state.pos=this.params.pos,this.paging=i(this.currentPage,this.totalPages),setTimeout((()=>{document.getElementById(this.table.containerId).scroll({top:0,left:0,behavior:"auto"})}),100),isFunction(this.table.afterFetch)&&this.table.afterFetch(this.params)}else this.table.url&&(this.meta.loading=!0,fetchData(this.table.url,this.params).then((t=>{this.rows=t.subset,this.state.total=t.total,this.state.count=t.count,this.state.pos=t.pos,this.paging=i(this.currentPage,this.totalPages),this.meta.loading=!1,document.getElementById(this.table.containerId).scroll({top:0,left:0,behavior:"auto"}),isFunction(this.table.afterFetch)&&this.table.afterFetch(this.params),this.fields.some((t=>t.decoder))&&this.rows.forEach((t=>{this.fields.filter((t=>t.decoder)).forEach((e=>{t[e.name]=e.decoder(t[e.name],e.name,t)}))}))}),(t=>{showPopup({message:t,type:"error"})})).catch((t=>showPopup({message:t,type:"error"}))))},afterConstruct(){let t=document.getElementById(this.form.modalId);t&&(this.formModal=t)},sidx(t){if("multiple"==this.table.sorting){let s=this.sort.findIndex((e=>e.col==t))+1;return e[s]}return""},pk(){return this.form.pk&&this.form.pk.reduce(((t,e)=>(t[e]=this.data[e],t)),{})},fprop(t){return this.fields.find((e=>e.name==t))},isWatched(t){return this.form.watch.indexOf(t)>-1},watcher(t){return this.fields.filter((e=>e.watch?.includes(t)))},get currentPage(){return this.state.pos+1},get totalPages(){return this.state.count},get totalRows(){return this.state.total},get firstDisplayedRow(){return this.state.total?s.format(this.params.size*this.state.pos+1):0},get lastDisplayedRow(){if(!this.state.total)return 0;let t=this.currentPage==this.totalPages?this.state.total:this.params.size*this.currentPage;return s.format(t)},get totalDisplayedRow(){return s.format(this.totalRows)},getSortIcon(t){const e={none:'<svg class="ml-1 w-3 h-3" fill="currentColor" viewBox="0 0 320 512">\n  <path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224zM292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/>\n</svg>',asc:'<svg class="ml-1 w-3 h-3" fill="currentColor" viewBox="0 0 320 512">\n  <path d="M27.66 224h264.7c24.6 0 36.89-29.78 19.54-47.12l-132.3-136.8c-5.406-5.406-12.47-8.107-19.53-8.107c-7.055 0-14.09 2.701-19.45 8.107L8.119 176.9C-9.229 194.2 3.055 224 27.66 224z"/>\n</svg>',desc:'<svg class="ml-1 w-3 h-3" fill="currentColor" viewBox="0 0 320 512">\n  <path d="M292.3 288H27.66c-24.6 0-36.89 29.77-19.54 47.12l132.5 136.8C145.9 477.3 152.1 480 160 480c7.053 0 14.12-2.703 19.53-8.109l132.3-136.8C329.2 317.8 316.9 288 292.3 288z"/>\n</svg>'};let s="none",i=this.sort.filter((e=>e.col==t))[0];return s=i?i.sort:"none",e[s]},toggleSortColumn(t){if("multiple"==this.table.sorting){let e=this.sort.findIndex((e=>e.col==t));e>-1?"asc"==this.sort[e].sort?this.sort[e].sort="desc":this.sort.splice(e,1):this.sort.push({col:t,sort:"asc"})}else"single"==this.table.sorting&&(this.sort[0]?.col==t?"asc"==this.sort[0].sort?this.sort[0].sort="desc":this.sort=[]:this.sort=[{col:t,sort:"asc"}])},goFirstPage(){this.params.pos=0,this.fetch()},goLastPage(){this.params.pos=this.state.count-1,this.fetch()},goNextPage(){this.currentPage<this.totalPages&&(this.params.pos=this.state.pos+1,this.fetch())},goPrevPage(){this.state.pos&&(this.params.pos=this.state.pos-1,this.fetch())},goToPage(t){t>0&&t<=this.totalPages&&(this.params.pos=t-1,this.fetch())},clearFilter(){[...document.querySelectorAll('input[id^="filter_"], textarea[id^="filter_"], select[id^="filter_"]')].forEach((t=>t.value="")),this.params.filter.forEach(((t,e,s)=>{s[e].value=""})),this.goFirstPage()},doSearch(){this.params.pos=0,this.fetch()},doSort(t){this.toggleSortColumn(t),this.params.sort=JSON.parse(JSON.stringify(this.sort)),this.params.sort=this.params.sort.map((t=>(t.col=this.table.queryTrans[t.col],t))),this.params.pos=0,this.fetch()},doSelect(t){if(this.table.selection&&"none"!=this.table.selection){if("multiple"==this.table.selection){let e=this.selection.indexOf(t);e>-1?this.selection.splice(e,1):this.selection.push(t)}else this.selection[0]==t?this.selection=[]:this.selection=[t];this.selection.length?(this.data={...this.rows[t]},this.dispatch("table-event",{event:"select",table:this.table.id,data:this.data})):(this.dispatch("table-event",{event:"deselect",table:this.table.id}),this.data={})}},selected(t){return this.selection.indexOf(t)>-1},toggleSelect(){this.selection=this.selection.length?[]:[...Array(this.rows.length).keys()]},submitting:!1,async addForm(){this.data={},this.fields.forEach((t=>this.data[t.name]=t.default||"")),this.errors={},this.form.oper="add",this.formModal.showModal(),document.querySelector("#modal-body input")?.focus(),isFunction(this.form.onShow)&&(this.data=await this.form.onShow(this.data,this.form.oper,this.params.filter)),this.fields.filter((t=>t.type?.match(/select/)&&isFunction(t.initOptions))).forEach((t=>t.initOptions(this.data,"add"))),this.fields.filter((t=>"checkbox"==t.type)).forEach((t=>document.querySelector(`[name="form_${t.name}"]`).checked=Boolean(this.data[t.name])))},async editForm(){this.selection.length&&(this.errors={},this.form.oper="edit",this.formModal.showModal(),document.querySelector("#modal-body input")?.focus(),this.fields.forEach((t=>{"date"==t.type&&(this.data[t.name]=dayjs(this.data[t.name]).format("YYYY-MM-DD")),"datetime-local"==t.type&&(this.data[t.name]=dayjs(this.data[t.name]).format("YYYY-MM-DDTHH:mm"))})),isFunction(this.form.onShow)&&(this.data=await this.form.onShow(this.data,this.form.oper,this.params.filter)),this.fields.filter((t=>t.type?.match(/select/)&&isFunction(t.initOptions))).forEach((t=>t.initOptions(this.data,"edit"))),this.fields.filter((t=>"checkbox"==t.type)).forEach((t=>document.querySelector(`[name="form_${t.name}"]`).checked=Boolean(this.data[t.name]))))},deleteDialog(){if(!this.selection.length)return;const t=this,e=this.pk();showPopup({title:"Delete",message:`Are you sure to delete '${Object.values(e).join(", ")}'?`,type:"confirm",buttons:[{title:"Ok",type:"ok",onclick(){this.close(),t.form.oper="del",t.validate(e)}},{title:"Cancel",type:"cancel",onclick(){this.close()}}]})},closeForm(){this.formModal.close()},validate(){let t=!0,e={};if(this.fields.filter((t=>t.validator)).forEach((s=>{let i=s.validator(this.data[s.name]);!0!==i&&(t=!1,e[s.name]=i)})),!t)return void(this.errors=e);let s=null;const i=this.fields.some((t=>"file"===t.type));if(isFunction(this.form.preSubmit)&&(this.data=this.form.preSubmit(this.data,this.form.oper)),i){let t=new FormData;this.fields.filter((t=>!t.virtual)).forEach((e=>{if("file"===e.type){let s=Array.isArray(this.data[e.name])?this.data[e.name]:[this.data[e.name]];s.forEach(((i,a)=>{t.append(e.name+(s.length>1?"#"+a:""),i,i.name)}))}else{let s=isFunction(e.encoder)?e.encoder(this.data[e.name],e.name,this.data):this.data[e.name]??"";t.append(`data[${e.name}]`,s)}})),t.append("oper",this.form.oper),this.form?.csrf?.value&&t.append("csrf",this.form.csrf.value),s=t}else{let t={};this.fields.filter((t=>!t.virtual)).forEach((e=>{let s=isFunction(e.encoder)?e.encoder(this.data[e.name],e.name,this.data):this.data[e.name]??"";t[e.name]=s})),s={oper:this.form.oper,data:t,csrf:this.form?.csrf?.value}}let a=i?formData:s;this.submitting=!0,fetchData(this.form.url,a,!i).then((t=>{let e=this.selection[0],s=t;switch(this.fields.filter((t=>t.decoder)).forEach((t=>{s[t.name]=t.decoder(s[t.name],t.name,s)})),document.querySelectorAll("#"+this.form.id+' [type="file"]').forEach((t=>t.value="")),this.form.oper){case"add":if(this.rows.unshift(s),this.selection.length&&(this.selection=this.selection.map((t=>t+1)),this.data={...this.rows[this.selection[0]]}),isFunction(this.form.onSubmitted)&&(this.data=this.form.onSubmitted(this.data,this.form.oper)),this.state.total++,this.form.continousInsert)return void this.addForm();break;case"edit":this.rows[e]=s,this.data=s,isFunction(this.form.onSubmitted)&&(this.data=this.form.onSubmitted(this.data,this.form.oper));break;case"del":this.selection.shift(),this.rows.splice(e,1),this.selection.length&&(this.selection=this.selection.map((t=>t>=e?t-1:t)),this.data={...this.rows[this.selection[0]]}),this.state.total--}this.formModal.close(),this.submitting=!1}),(t=>{this.errors=t,"[object String]"===toString.call(t)&&showPopup({message:t,type:"error"}),this.submitting=!1}))},deleteUrl:"",uploadUrl:"",downloadUrl:"",fileUpload:null,uploadProcess(t,e,s){this.uploadUrl?(this.fileUpload.click(),this.fileUpload.setAttribute("data-description",t),this.fileUpload.setAttribute("data-callback",e),s&&this.fileUpload.setAttribute("data-other",s)):popupError("Uploader is not initialized")},UploadCallback(t,e){this.data[e]=t,this.fileUpload.value=null},DeleteFile(t){if(!this.deleteUrl)return void popupError("Uploader is not initialized");let e=this.data[t];e.downloadkey&&popupDialog("Delete file",`Delete file "${e.name}"?`,(()=>{fetchData(this.deleteUrl,{downloadkey:e.downloadkey}),this.data[t]={}}))},initUploader(t,e,s,i){this.uploadUrl=t,this.deleteUrl=e,this.downloadUrl=s;const a=document.createElement("input");a.setAttribute("type","file"),a.setAttribute("id","fileUpload"+Math.floor(100*Math.random())),a.setAttribute("accept",i),a.setAttribute("class","hidden"),a.addEventListener("change",(()=>{const e=a.files[0];if(e){const s=a.getAttribute("data-callback"),i=a.getAttribute("data-description"),o=a.getAttribute("data-other"),r=new FormData;r.append("description",i),r.append("file",e),fetchData(t,r,!1).then((t=>this[s](t,o))).catch((t=>popupError(t)))}})),document.body.append(a),this.fileUpload=a},saveCsv(){let t=this.titles.map((t=>JSON.stringify(t))).join(",")+"\n"+this.rows.map((t=>this.cols.map((e=>t[e])).map((t=>JSON.stringify(t))).join(","))).join("\n"),e=new Blob([t],{type:"text/plain;charset=utf-8"});saveAs(e,(this.form.object||"Data")+".csv")},setFooterVal(t,e){this.table.footerData.forEach((s=>{s.every((s=>s.name!==t||(s.value=e,!1)))}))},eventHandler(t){t.table==this.table.id&&this.table.eventHandler?.(t.event,t.data),t.table==this.table.masterId&&isFunction(this.table.masterChanged)&&("select"==t.event?this.params.limit=this.table.masterChanged(t.data):"deselect"==t.event&&(this.params.limit=this.table.limit),this.fetch())},valueChange(t){!t.table!=this.table.id&&this.watcher(t.field).forEach((t=>isFunction(t.triggerChange)&&t.triggerChange(this.data)))}}}